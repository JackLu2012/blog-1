
# react native之增量更新

## 前言

作为ios客户端来讲，采用react native技术主要目的还是动态更新，跨平台到在其次。

很尴尬，需要更新的脚本太大，release模式下基础库容量就有几百K，小app当然无所谓，但产品级别没有谁能忍受每次都下载这么大的全量包，哪怕你就修改了一行代码。

于是新的需求出现了，除了可以动态更新之外，还需要增量更新。很可惜，react native不管你这个，自己解决。

## 增量需求

增量更新分两种：一是资源的增量更新，主要是图片资源；二是代码的增量更新。

微软的codepush增量更新方案应该是react native最早的方案，只支持图片资源增量，不支持代码增量。而且作为产品来讲，将代码这种命脉放在第三方也不太科学。所以最好的方式就是，自己实现两种增量算法。

## 图片资源增量算法

codepush开源了客户端的源码，所以我们可以通过codepush源码一探究竟。

详细代码流程就不在这里说了，大致流程：

codepush每次启动都会检测时候有新的版本，如果有，则会将资源和代码下载到本地的固定目录，并重新加载。图片的增量算法思路比较简单，具体实现可能要繁琐些。图片有三中状态：1、已存在；2、已过期；3、新增。所以服务端只要维护一个新增列表和需要删除的列表，下发给客户端执行，就可以实现图片资源的增量。

安全，关于网络资源的安全控制，思路都差不多，都是把资源压缩，然后压缩文件md5或sha-1，然后对这个hash值进行rsa加密，防止中途环节被篡改。至于源码和资源被窃取的安全策略都不做。

server端根据客户端的功能，实现逻辑也不复杂。

## 代码增量算法

代码增量算法更简单些，js即是文本，所以只需要算出源码之间的差异作为补丁文件，然后下发补丁文件，在客户端合并补丁即可。因为要考虑基础库，也就是react native的版本问题，具体实现策略根据业务场景略有不同。

比如我们APP类似与一个平台，除了支撑自身的业务之外，还要支撑所有第三方的业务组件。如果采用react native技术，不同的第三方以及与我们APP的react native版本可能均不相同，如何支撑不同的版本，还要尽量减少补丁文件的大小，解决起来就要复杂些。

那么如何做代码的差异比较，以及合并呢？这里推荐google-diff-match库，这个库上篇文章专门介绍了一下，它的优势是支撑多语言，无论客户端还是服务端，都不必做额外开发，直接集成使用，使用方式也简单。文本匹配的另一个好处是，版本差异无关性，也就是说，当存在多个补丁文件时，依然可以一个补丁从基础版本直接升级到最新版，不用一个个的打补丁。

安全，和资源增量打在一个包里，所以安全策略是一样的。

暂时就这么多，走个流水账，后续再补充……